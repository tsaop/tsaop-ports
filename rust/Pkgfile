# Description:	The Rust language with Cargo included.
# URL:		http://www.rust-lang.org/
# Maintainer:	Fredrik Rinnestam, fredrik at crux dot guru
# Depends on:	llvm

name=rust
version=1.31.1
release=1
source=(https://static.rust-lang.org/dist/${name}c-$version-src.tar.gz \
	https://static.rust-lang.org/dist/2018-10-25/rust-std-1.30.0-x86_64-unknown-linux-gnu.tar.gz \
	https://static.rust-lang.org/dist/2018-10-25/rustc-1.30.0-x86_64-unknown-linux-gnu.tar.gz \
	https://static.rust-lang.org/dist/2018-10-25/cargo-0.31.0-x86_64-unknown-linux-gnu.tar.gz
	config.toml
	system-llvm-with-enabled-ffi.patch)
 
build() {
	cd ${name}c-$version-src

	cp $SRC/config.toml .

	# Workaround for rust-lang/rust#39880
	patch -Np1 -i $SRC/system-llvm-with-enabled-ffi.patch
	
	mkdir -p build/cache/2018-10-25
	cp $PKGMK_SOURCE_DIR/rust-std-1.30.0-x86_64-unknown-linux-gnu.tar.gz build/cache/2018-10-25/
	cp $PKGMK_SOURCE_DIR/rustc-1.30.0-x86_64-unknown-linux-gnu.tar.gz build/cache/2018-10-25/
	cp $PKGMK_SOURCE_DIR/cargo-0.31.0-x86_64-unknown-linux-gnu.tar.gz build/cache/2018-10-25/

	/usr/bin/python ./x.py build -j$(nproc)
	DESTDIR=$PKG /usr/bin/python ./x.py install

	#cleanup
	rm -r $PKG/usr/share/doc
	rm -r $PKG/usr/share/zsh
	rm -r $PKG/usr/etc
	rm $PKG/usr/lib/rustlib/{components,manifest-rustc,rust-installer-version,uninstall.sh}
}
