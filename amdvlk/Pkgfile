# Description: AMD Open Source Driver For Vulkan
# URL: https://github.com/GPUOpen-Drivers/AMDVLK
# Maintainer: Tsaop, leeroy at cock dot li
# Depends on: cmake gnupg python3 xorg-dri2proto xorg-dri3proto xorg-libx11 xorg-libxshmfence git

name=amdvlk
version=9999
release=2
source=(https://storage.googleapis.com/git-repo-downloads/repo
	c++14-fixes.patch
	amdPalSettings.cfg)

build() {
	chmod +x repo
	mkdir $name; cd $name
	$SRC/repo init -u https://github.com/GPUOpen-Drivers/AMDVLK.git -b master
	$SRC/repo sync

	cd $SRC/$name/drivers/pal
	patch -Np1 -i $SRC/c++14-fixes.patch

	cd $SRC/$name/drivers/xgl
	cmake -H. -Bbuilds/Release64 \
	       	-DCMAKE_BUILD_TYPE=Release \
	       	-DCMAKE_MODULE_PATH=$PWD/../pal/cmake/Modules \
		-DXGL_PAL_PATH:PATH=$PWD/../pal \
		-DCMAKE_C_FLAGS="-DLINUX -D__x86_64__ -D__AMD64__" \
		-DCMAKE_CXX_FLAGS="-DLINUX -D__x86_64__ -D__AMD64__" \
		-DXGL_LLVM_SRC_PATH=$PWD/../llvm

	cd builds/Release64
	make

	install -dm755 $PKG/usr/lib
	install -dm755 $PKG/etc/amd
	install -dm755 $PKG/usr/share/vulkan/icd.d

	install -Dm644 $SRC/amdPalSettings.cfg $PKG/etc/amd/amdPalSettings.cfg
	install -Dm755 icd/amdvlk64.so $PKG/usr/lib/amdvlk64.so

	# Fix library path in the json file
	sed -i 's|x86_64-linux-gnu/||' $SRC/$name/drivers/${name^^}/json/Ubuntu/amd_icd64.json
	install -Dm644 $SRC/$name/drivers/${name^^}/json/Ubuntu/amd_icd64.json $PKG/usr/share/vulkan/icd.d/amd_icd64.json
}
